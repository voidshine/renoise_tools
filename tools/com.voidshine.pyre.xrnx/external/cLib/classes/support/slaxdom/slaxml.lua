local a={VERSION="0.7",_call={pi=function(b,c)print(string.format("<?%s %s?>",b,c))end,comment=function(c)print(string.format("<!-- %s -->",c))end,startElement=function(d,e,f)io.write("<")if f then io.write(f,":")end;io.write(d)if e then io.write(" (ns='",e,"')")end;print(">")end,attribute=function(d,g,e,f)io.write('  ')if f then io.write(f,":")end;io.write(d,'=',string.format('%q',g))if e then io.write(" (ns='",e,"')")end;io.write("\n")end,text=function(h)print(string.format("  text: %q",h))end,closeElement=function(d,e,f)print(string.format("</%s>",d))end}}function a:parser(i)return{_call=i or self._call,parse=a.parse}end;function a:parse(j,k)if not k then k={stripWhitespace=false}end;local l,m,n,o,p,q,r=string.find,string.sub,string.gsub,string.char,table.insert,table.remove,table.concat;local s,t,u,v,w,x,e;local unpack=unpack or table.unpack;local y=1;local z="text"local A=1;local B={}local C={}local D;local E={}local F=false;local G={{0x7FF,192},{0xFFFF,224},{0x1FFFFF,240}}local function H(I)if I<128 then return o(I)end;local J={}for K,L in ipairs(G)do if I<=L[1]then for M=K+1,2,-1 do local N=I%64;I=(I-N)/64;J[M]=o(128+N)end;J[1]=o(L[2]+I)return r(J)end end end;local O={["lt"]="<",["gt"]=">",["amp"]="&",["quot"]='"',["apos"]="'"}local P=function(Q,R,S)return O[S]or R=="#"and H(tonumber('0'..S))or Q end;local function T(U)return n(U,'(&(#?)([%d%a]+);)',P)end;local function V()if s>A and self._call.text then local h=m(j,A,s-1)if k.stripWhitespace then h=n(h,'^%s+','')h=n(h,'%s+$','')if#h==0 then h=nil end end;if h then self._call.text(T(h))end end end;local function W()s,t,u,v=l(j,'^<%?([:%a_][:%w_.-]*) ?(.-)%?>',y)if s then V()if self._call.pi then self._call.pi(u,v)end;y=t+1;A=y;return true end end;local function X()s,t,u=l(j,'^<!%-%-(.-)%-%->',y)if s then V()if self._call.comment then self._call.comment(u)end;y=t+1;A=y;return true end end;local function Y(Z)if Z=='xml'then return'http://www.w3.org/XML/1998/namespace'end;for _=#E,1,-1 do if E[_][Z]then return E[_][Z]end end;error(("Cannot find namespace for prefix %s"):format(Z))end;local function a0()F=true;s,t,u=l(j,'^<([%a_][%w_.-]*)',y)if s then B[2]=nil;B[3]=nil;V()y=t+1;s,t,v=l(j,'^:([%a_][%w_.-]*)',y)if s then B[1]=v;B[3]=u;u=v;y=t+1 else B[1]=u;for _=#E,1,-1 do if E[_]['!']then B[2]=E[_]['!']break end end end;D=0;p(E,{})return true end end;local function a1()s,t,u=l(j,'^%s+([:%a_][:%w_.-]*)%s*=%s*',y)if s then x=t+1;s,t,v=l(j,'^"([^<"]*)"',x)if s then y=t+1;v=T(v)else s,t,v=l(j,"^'([^<']*)'",x)if s then y=t+1;v=T(v)end end end;if u and v then local a2={u,v}local Z,d=string.match(u,'^([^:]+):([^:]+)$')if Z then if Z=='xmlns'then E[#E][d]=v else a2[1]=d;a2[4]=Z end else if u=='xmlns'then E[#E]['!']=v;B[2]=v end end;D=D+1;C[D]=a2;return true end end;local function a3()s,t,u=l(j,'^<!%[CDATA%[(.-)%]%]>',y)if s then V()if self._call.text then self._call.text(u)end;y=t+1;A=y;return true end end;local function a4()s,t,u=l(j,'^%s*(/?)>',y)if s then z="text"y=t+1;A=y;if B[3]then B[2]=Y(B[3])end;if self._call.startElement then self._call.startElement(unpack(B))end;if self._call.attribute then for _=1,D do if C[_][4]then C[_][3]=Y(C[_][4])end;self._call.attribute(unpack(C[_]))end end;if u=="/"then q(E)if self._call.closeElement then self._call.closeElement(unpack(B))end end;return true end end;local function a5()s,t,u,v=l(j,'^</([%a_][%w_.-]*)%s*>',y)if s then e=nil;for _=#E,1,-1 do if E[_]['!']then e=E[_]['!']break end end else s,t,v,u=l(j,'^</([%a_][%w_.-]*):([%a_][%w_.-]*)%s*>',y)if s then e=Y(v)end end;if s then V()if self._call.closeElement then self._call.closeElement(u,e)end;y=t+1;A=y;q(E)return true end end;while y<#j do if z=="text"then if not(W()or X()or a3()or a5())then if a0()then z="attributes"else s,t=l(j,'^[^<]+',y)y=(s and t or y)+1 end end elseif z=="attributes"then if not a1()then if not a4()then error("Was in an element and couldn't find attributes or the close.")end end end end;if not F then error("Parsing did not discover any elements")end;if#E>0 then error("Parsing ended with unclosed elements")end end;return a