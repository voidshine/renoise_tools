local setmetatable,tonumber,tostring=setmetatable,tonumber,tostring;local a,b=math.floor,math.huge;local c,d=math.mininteger or nil,math.tointeger or nil;local e,f,g,h,i,j=string.byte,string.char,string.find,string.gsub,string.match,string.sub;local function k(l,m)error("parse error at "..l..": "..m,2)end;local n;if _VERSION=="Lua 5.1"then n='[^\32-\255]'else n='[\0-\31]'end;local o=nil;local function p()local q,l,r,s,t;local u,v;local function w(m)return k(l,m)end;local function x()w('invalid value')end;local function y()if j(q,l,l+2)=='ull'then l=l+3;return r end;w('invalid value')end;local function z()if j(q,l,l+3)=='alse'then l=l+4;return false end;w('invalid value')end;local function A()if j(q,l,l+2)=='rue'then l=l+3;return true end;w('invalid value')end;local B=i(tostring(0.5),'[^0-9]')local C=tonumber;if B~='.'then if g(B,'%W')then B='%'..B end;C=function(D)return tonumber(h(D,'.',B))end end;local function E()return w('invalid number')end;local function F(G)local H,I=i(q,'^(%.?[0-9]*)([-+.A-Za-z]?)',l)if H==''then if I==''then if G then return-0.0 end;return 0 end;if I=='e'or I=='E'then H,I=i(q,'^([^eE]*[eE][-+]?[0-9]+)([-+.A-Za-z]?)',l)if I==''then l=l+#H;if G then return-0.0 end;return 0.0 end end;E()end;if e(H)~=0x2E or e(H,-1)==0x2E then E()end;if I~=''then if I=='e'or I=='E'then H,I=i(q,'^([^eE]*[eE][-+]?[0-9]+)([-+.A-Za-z]?)',l)end;if I~=''then E()end end;l=l+#H;I=C(H)if G then I=-I end;return I end;local function J(G)l=l-1;local H,I=i(q,'^([0-9]+%.?[0-9]*)([-+.A-Za-z]?)',l)if e(H,-1)==0x2E then E()end;if I~=''then if I~='e'and I~='E'then E()end;H,I=i(q,'^([^eE]*[eE][-+]?[0-9]+)([-+.A-Za-z]?)',l)if not H or I~=''then E()end end;l=l+#H;I=C(H)if G then I=-I;if I==c and not g(H,'[^0-9]')then I=c end end;return I end;local function K()local I=e(q,l)if I then l=l+1;if I>0x30 then if I<0x3A then return J(true)end else if I>0x2F then return F(true)end end end;w('invalid number')end;local L={0x0,0x1,0x2,0x3,0x4,0x5,0x6,0x7,0x8,0x9,b,b,b,b,b,b,b,0xA,0xB,0xC,0xD,0xE,0xF,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,b,0xA,0xB,0xC,0xD,0xE,0xF,__index=function()return b end}setmetatable(L,L)local M={['"']='"',['\\']='\\',['/']='/',['b']='\b',['f']='\f',['n']='\n',['r']='\r',['t']='\t',__index=function()w("invalid escape sequence")end}setmetatable(M,M)local function N()return w("1st surrogate pair byte not continued by 2nd")end;local O=0;local function P(Q,R)if Q=='u'then local S,T,U,V,W=e(R,1,5)R=L[S-47]*0x1000+L[T-47]*0x100+L[U-47]*0x10+L[V-47]if R~=b then if R<0x80 then if W then return f(R,W)end;return f(R)elseif R<0x800 then S=a(R/0x40)T=R-S*0x40;S=S+0xC0;T=T+0x80;if W then return f(S,T,W)end;return f(S,T)elseif R<0xD800 or 0xE000<=R then S=a(R/0x1000)R=R-S*0x1000;T=a(R/0x40)U=R-T*0x40;S=S+0xE0;T=T+0x80;U=U+0x80;if W then return f(S,T,U,W)end;return f(S,T,U)elseif 0xD800<=R and R<0xDC00 then if O==0 then O=R;if not W then return''end;N()end;O=0;N()else if O~=0 then R=0x10000+(O-0xD800)*0x400+R-0xDC00;O=0;S=a(R/0x40000)R=R-S*0x40000;T=a(R/0x1000)R=R-T*0x1000;U=a(R/0x40)V=R-U*0x40;S=S+0xF0;T=T+0x80;U=U+0x80;V=V+0x80;if W then return f(S,T,U,V,W)end;return f(S,T,U,V)end;w("2nd surrogate pair byte appeared without 1st")end end;w("invalid unicode codepoint literal")end;if O~=0 then O=0;N()end;return M[Q]..R end;local X=setmetatable({},{__mode="v"})local function Y(Z)local _=l;local a0,S,T;repeat _=g(q,'"',_,true)if not _ then w("unterminated string")end;a0=_-1;_=_+1;S,T=e(q,a0-1,a0)if T==0x5C and S==0x5C then repeat a0=a0-2;S,T=e(q,a0-1,a0)until T~=0x5C or S~=0x5C;a0=_-2 end until T~=0x5C;local a1=j(q,l,a0)l=_;if Z then a0=X[a1]if a0 then return a0 end;a0=a1 end;if g(a1,n)then w("unescaped control string")end;if g(a1,'\\',1,true)then a1=h(a1,'\\(.)([^\\]?[^\\]?[^\\]?[^\\]?[^\\]?)',P)if O~=0 then O=0;w("1st surrogate pair byte not continued by 2nd")end end;if Z then X[a0]=a1 end;return a1 end;local function a2()t=t+1;if t>1000 then w('too deeply nested json (> 1000)')end;local a3={}l=i(q,'^[ \n\r\t]*()',l)local a4=0;if e(q,l)==0x5D then l=l+1 else local _=l;repeat a4=a4+1;v=u[e(q,_)]l=_+1;a3[a4]=v()_=i(q,'^[ \n\r\t]*,[ \n\r\t]*()',l)until not _;_=i(q,'^[ \n\r\t]*%]()',l)if not _ then w("no closing bracket of an array")end;l=_ end;if s then a3[0]=a4 end;t=t-1;return a3 end;local function a5()t=t+1;if t>1000 then w('too deeply nested json (> 1000)')end;local a6={}l=i(q,'^[ \n\r\t]*()',l)if e(q,l)==0x7D then l=l+1 else local _=l;repeat if e(q,_)~=0x22 then w("not key")end;l=_+1;local a7=Y(true)v=x;local S,T,U=e(q,l,l+3)if S==0x3A then if T~=0x20 then v=u[T]_=l+2 else v=u[U]_=l+3 end end;if v==x then _=i(q,'^[ \n\r\t]*:[ \n\r\t]*()',l)if not _ then w("no colon after a key")end;v=u[e(q,_)]_=_+1 end;l=_;a6[a7]=v()_=i(q,'^[ \n\r\t]*,[ \n\r\t]*()',l)until not _;_=i(q,'^[ \n\r\t]*}()',l)if not _ then w("no closing bracket of an object")end;l=_ end;t=t-1;return a6 end;u={[0]=x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,Y,x,x,x,x,x,x,x,x,x,x,K,x,x,F,J,J,J,J,J,J,J,J,J,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,x,a2,x,x,x,x,x,x,x,x,x,x,z,x,x,x,x,x,x,x,y,x,x,x,x,x,A,x,x,x,x,x,x,a5,x,x,x,x,__index=function()w("unexpected termination")end}setmetatable(u,u)local function a8(a9,aa,ab,ac)q,l,r,s=a9,aa,ab,ac;t=0;l=i(q,'^[ \n\r\t]*()',l)v=u[e(q,l)]l=l+1;local ad=v()if aa then return ad,l else v,l=g(q,'^[ \n\r\t]*',l)if l~=#q then w('json ended')end;return ad end end;return a8 end;return p